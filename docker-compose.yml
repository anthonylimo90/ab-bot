services:
  # ===========================================================================
  # Database Services
  # ===========================================================================
  postgres:
    image: timescale/timescaledb:latest-pg16
    container_name: ab-bot-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-abbot}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-abbot_secret}
      POSTGRES_DB: ${POSTGRES_DB:-ab_bot}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-abbot} -d ${POSTGRES_DB:-ab_bot}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ab-bot-network

  redis:
    image: redis:7-alpine
    container_name: ab-bot-redis
    environment:
      REDIS_APP_PASSWORD: ${REDIS_APP_PASSWORD:-app_secret_change_me}
      REDIS_DYNAMIC_TUNER_PASSWORD: ${REDIS_DYNAMIC_TUNER_PASSWORD:-dynamic_tuner_secret_change_me}
      REDIS_DYNAMIC_SUBSCRIBER_PASSWORD: ${REDIS_DYNAMIC_SUBSCRIBER_PASSWORD:-dynamic_subscriber_secret_change_me}
    volumes:
      - redis_data:/data
      - ./docker/redis/redis-entrypoint.sh:/usr/local/etc/redis/redis-entrypoint.sh:ro
    command: sh /usr/local/etc/redis/redis-entrypoint.sh
    healthcheck:
      test: ["CMD-SHELL", "redis-cli --user app --pass ${REDIS_APP_PASSWORD:-app_secret_change_me} ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - ab-bot-network

  # ===========================================================================
  # Application Services
  # ===========================================================================
  api-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ab-bot-api
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-abbot}:${POSTGRES_PASSWORD:-abbot_secret}@postgres:5432/${POSTGRES_DB:-ab_bot}
      REDIS_URL: redis://app:${REDIS_APP_PASSWORD:-app_secret_change_me}@redis:6379
      DYNAMIC_TUNER_REDIS_URL: redis://dynamic_tuner:${REDIS_DYNAMIC_TUNER_PASSWORD:-dynamic_tuner_secret_change_me}@redis:6379
      DYNAMIC_CONFIG_REDIS_URL: redis://dynamic_subscriber:${REDIS_DYNAMIC_SUBSCRIBER_PASSWORD:-dynamic_subscriber_secret_change_me}@redis:6379
      API_HOST: 0.0.0.0
      API_PORT: 3000
      # JWT_SECRET is required - generate with: openssl rand -base64 32
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET must be set to a secure value (min 32 chars)}
      CORS_PERMISSIVE: ${CORS_PERMISSIVE:-true}
      RUST_LOG: ${RUST_LOG:-api_server=info,tower_http=info}
      SKIP_MIGRATIONS: "true"
      # Workspace/runtime toggles
      COPY_TRADING_ENABLED: ${COPY_TRADING_ENABLED:-true}
      COPY_MIN_TRADE_VALUE: ${COPY_MIN_TRADE_VALUE:-5}
      COPY_MAX_SLIPPAGE_PCT: ${COPY_MAX_SLIPPAGE_PCT:-0.01}
      COPY_MAX_LATENCY_SECS: ${COPY_MAX_LATENCY_SECS:-90}
      COPY_DAILY_CAPITAL_LIMIT: ${COPY_DAILY_CAPITAL_LIMIT:-5000}
      COPY_MAX_OPEN_POSITIONS: ${COPY_MAX_OPEN_POSITIONS:-15}
      COPY_STOP_LOSS_ENABLED: ${COPY_STOP_LOSS_ENABLED:-true}
      COPY_STOP_LOSS_CHECK_SECS: ${COPY_STOP_LOSS_CHECK_SECS:-30}
      COPY_STOP_LOSS_PCT: ${COPY_STOP_LOSS_PCT:-0.15}
      COPY_TAKE_PROFIT_PCT: ${COPY_TAKE_PROFIT_PCT:-0.25}
      COPY_MAX_HOLD_HOURS: ${COPY_MAX_HOLD_HOURS:-72}
      COPY_MIRROR_EXITS: ${COPY_MIRROR_EXITS:-true}
      TRADE_MONITOR_MAX_AGE_SECS: ${TRADE_MONITOR_MAX_AGE_SECS:-900}
      TRADE_MONITOR_WALLET_LIMIT: ${TRADE_MONITOR_WALLET_LIMIT:-100}
      ARB_AUTO_EXECUTE: ${ARB_AUTO_EXECUTE:-false}
      ARB_POSITION_SIZE: ${ARB_POSITION_SIZE:-50}
      ARB_MIN_NET_PROFIT: ${ARB_MIN_NET_PROFIT:-0.001}
      ARB_MIN_BOOK_DEPTH: ${ARB_MIN_BOOK_DEPTH:-100}
      LIVE_TRADING: ${LIVE_TRADING:-false}
      EXECUTOR_MIN_BOOK_DEPTH: ${EXECUTOR_MIN_BOOK_DEPTH:-100}
      DYNAMIC_TUNER_BOOTSTRAP_ENABLED: ${DYNAMIC_TUNER_BOOTSTRAP_ENABLED:-true}
      DYNAMIC_TUNER_BOOTSTRAP_MAX_ATTEMPTS: ${DYNAMIC_TUNER_BOOTSTRAP_MAX_ATTEMPTS:-100}
      DYNAMIC_TUNER_NO_TRADE_WINDOW_MINUTES: ${DYNAMIC_TUNER_NO_TRADE_WINDOW_MINUTES:-120}
      DYNAMIC_TUNER_NO_TRADE_MIN_ATTEMPTS: ${DYNAMIC_TUNER_NO_TRADE_MIN_ATTEMPTS:-20}
    ports:
      - "${API_PORT:-3000}:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - ab-bot-network
    restart: unless-stopped

  arb-monitor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ab-bot-arb-monitor
    environment:
      SERVICE: arb-monitor
      DATABASE_URL: postgres://${POSTGRES_USER:-abbot}:${POSTGRES_PASSWORD:-abbot_secret}@postgres:5432/${POSTGRES_DB:-ab_bot}
      REDIS_URL: redis://app:${REDIS_APP_PASSWORD:-app_secret_change_me}@redis:6379
      DYNAMIC_CONFIG_REDIS_URL: redis://dynamic_subscriber:${REDIS_DYNAMIC_SUBSCRIBER_PASSWORD:-dynamic_subscriber_secret_change_me}@redis:6379
      RUST_LOG: ${RUST_LOG:-arb_monitor=info}
      POLYMARKET_API_URL: ${POLYMARKET_API_URL:-https://clob.polymarket.com}
      POLLING_INTERVAL_MS: ${POLLING_INTERVAL_MS:-1000}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/healthy"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - ab-bot-network
    restart: unless-stopped

  bot-scanner:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ab-bot-scanner
    environment:
      SERVICE: bot-scanner
      DATABASE_URL: postgres://${POSTGRES_USER:-abbot}:${POSTGRES_PASSWORD:-abbot_secret}@postgres:5432/${POSTGRES_DB:-ab_bot}
      RUST_LOG: ${RUST_LOG:-bot_scanner=info}
      POLYGON_RPC_URL: ${POLYGON_RPC_URL:-}
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "test -f /tmp/healthy"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    networks:
      - ab-bot-network
    restart: unless-stopped
    profiles:
      - full  # Only run with --profile full

  # ===========================================================================
  # Monitoring Services (optional)
  # ===========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: ab-bot-prometheus
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./docker/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - ab-bot-network
    profiles:
      - monitoring

  grafana:
    image: grafana/grafana:latest
    container_name: ab-bot-grafana
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: false
    volumes:
      - grafana_data:/var/lib/grafana
      - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    networks:
      - ab-bot-network
    profiles:
      - monitoring

# ===========================================================================
# Networks & Volumes
# ===========================================================================
networks:
  ab-bot-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:
